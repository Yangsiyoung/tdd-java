테스트 코드의 구성
===============

# 상황, 실행, 결과 확인
테스트 코드의 기본 골격은 아래와 같다.  
특정 상황이 주어지고(given) -> 기능을 실행하고(when) -> 결과 확인(then)  
꼭 이 구조를 지켜야하는 건 아니고, 테스트 구조를 보고 테스트 내용을 이해할 수 있으면 된다.  
그리고 항상 상황이 있는 건 아니다, 앞선 [암호 강도 측정](https://github.com/Yangsiyoung/tdd-java/tree/master/src/main/java/tdd/chapter02) 의 경우  
상황이 없이 암호에 대한 기능을 실행하고 결과만 확인 했을 뿐이다.  

* 상황이 있는 예
```
@DisplayName("정답일 경우")
@Test
public void exactMatch() {
    // 야구 게임 정답이 456인 상황
    BaseballGame baseballGame = new BaseballGame("456");
    int expectStrikeCount = 3;
    int expectBallCount = 0;
    // 기능 실행
    Score score = baseballGame.guess("456");
    // 결과 확인
    assertEquals(expectStrikeCount, score.strikes());
    assertEquals(expectBallCount, score.balls());
}

@DisplayName("오답일 경우")
@Test
public void noMatch() {
    // 야구 게임 정답이 123인 상황
    BaseballGame baseballGame = new BaseballGame("123");
    int expectStrikeCount = 0;
    int expectBallCount = 0;
    // 기능 실행
    Score score = baseballGame.guess("456");
    // 결과 확인
    assertEquals(expectStrikeCount, score.strikes());
    assertEquals(expectBallCount, score.balls());
}
```

그리고 결과가 항상 리턴 값이 있는 것 이 아니라  
익섹션이 발생해야 정상인 경우도 있다.  
따라서 테스트 내용이 목적에 맞게 잘 작성되어 있으면 된다.  

# 외부 상황과 외부 결과
예를 들어 서버에 업로드 된 파일을 가져와서 읽으며  
해당 파일의 내용을 한줄 씩 읽으며 로직을 수행하는 코드를 검증해야 한다고 하자.  

먼저 파일이 존재하지 않을 경우에 대한 테스트를 작성한다고 해보자.  
파일이 없을 법한 경로를 선택해 존재하지 않게 해두었겠지만 시간이 지나서  
해당 경로에 파일을 누군가 업로드 해두었을 수 있다.  

이럴경우 테스트는 항상 언제 실행해도 정상 동작해야하는데 실패하게 되며  
그래서 테스트를 신뢰할 수 없게 된다.  

## 외부 상태가 테스트 결과에 영향을 미치면 안된다.  
회원가입을 예로 생각해보자.  
먼저 회원가입 기능 메서드의 기능은 아래와 같다.  
* 아이디가 중복되는지 검사.
* 조건이 충족되면 회원가입 성공

해당 기능을 테스트하려면 DB 에 중복된 아이디가 있는지 검사 후  
중복에 따른 테스트, 중복이 아닐 경우 회원가입 완료 테스트를 할 것이다.  
그런데 하루 전에는 "test1" 이라는 계정이 존재하지 않아서  
테스트 시 회원가입이 성공했는데 누군가 해당 아이디로 가입을 해버려서  
이제는 실패한 테스트가 되었다면???  

이를 방지하기 위해서 실행 전에 외부 상태를 원하는 상태로 만들거나  
테스트 실행 후에 외부 상태를 원래대로 돌려 놓아야 한다.  
(이 경우엔 원하는 대로 DB 쿼리를 날려서 테스트 세팅을 하고, 테스트 한 후에  
 트랜잭션 롤백하면 될거같다.)  
 
 ## 외부 상태와 테스트 어려움
 외부 요인의 경우 파일, DBMS, 외부 서버 등 다양하다.  
 즉, 내가 짠 기능에 이슈가 있어서가 아니라 외부 요인에 의해 테스트가 실패할수도 있다.  

예를들어 계좌 송금에 대한 기능을 구현하고 테스트 할 때  
계좌 송금의 경우 외부 업체에서 제공하는 REST API 를 사용한다고 가정해보자.  
그러면 외부 REST API 를 테스트 해야하는 상황이고, 아래의 경우를 테스트해야한다.  
  
* REST API 응답 결과가 유효하지 않은 경우
* REST API 응답 결과가 유효하지 않은 계좌번호인 상황
* REST API 서버에 연결할 수 없는 상황
* REST API 서버에서 응답을 5초 이내에 받지 못하는 상황  

여기서 REST API 서버에 연결할 수 없는 상황이나, REST API 응답을 지정한 시간안에  
응답을 받지 못하도록 하는 상황은 어떻게 할 수 있을까?  
REST API 제공업체에 테스트 돌리는 동안 서버를 죽여달라고 하거나, 응답을 7초 뒤에 주도록  
수정해달라고 매번 요청할수는 없다.  

그래서 외부 상황은 테스트 코드에서 마음대로 제어할 수 없는 경우가 많다.    
이렇게 테스트 대상의 상황과 결과에 외부 요인이 관여할 경우 대역을 사용하면 작성이 쉬워지는데  
대역은 테스트 대상이 의존하는 대상의 실제 구현을 대신하는 구현인데 이것을 통해서  
외부 상황이나 결과를 대체할 수 있다.  
  
 
  



